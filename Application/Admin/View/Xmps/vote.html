<?php showViewsByPower() ?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link href="__PUBLIC__/vendor/bootstrap-table/bootstrap/css/bootstrap.min.css" rel="stylesheet" >
    <link href="__PUBLIC__/vendor/switchery/switchery.css" rel="stylesheet">
    <link href="__PUBLIC__/vendor/chosen/chosen.css" rel="stylesheet">
    <link href="__PUBLIC__/font-awesome/css/font-awesome.css" rel="stylesheet">

    <link href="__PUBLIC__/vendor/bootstrap-table/bootstrap-table/src/bootstrap-table.css" rel="stylesheet" >
    <link href="__PUBLIC__/vendor/bootstrap-table/bootstrap-table/src/bootstrap-editable/css/bootstrap-editable.css" rel="stylesheet" >
    <link href="__PUBLIC__/css/style.css?v=4.0.0" rel="stylesheet">
    <link rel="stylesheet" href="__PUBLIC__/vendor/layui/css/layui.css" media="all" />
    <script src="__PUBLIC__/vendor/jquery/jquery1.11.1.js"></script>
    <script src="__PUBLIC__/vendor/bootstrap-table/bootstrap/js/bootstrap.min.js"></script>

    <script src="__PUBLIC__/vendor/switchery/switchery.js"></script>
    <script src="__PUBLIC__/vendor/chosen/chosen.jquery.js"></script>
    <script src="__PUBLIC__/vendor/chosen/chosen.order.jquery.js"></script>
    <script src="__PUBLIC__/vendor/chosen-ajax-addition/chosen.ajaxaddition.jquery.js"></script>

    <script src="__PUBLIC__/vendor/bootstrap-table/bootstrap-table/src/bootstrap-table.js"></script>
    <script src="__PUBLIC__/vendor/bootstrap-table/bootstrap-table/src/locale/bootstrap-table-zh-CN.js"></script>
    <script src="__PUBLIC__/vendor/bootstrap-table/bootstrap-table/src/bootstrap-editable/js/bootstrap-editable.js"></script>
    <script src="__PUBLIC__/vendor/bootstrap-table/bootstrap-table/src/extensions/editable/bootstrap-table-editable.js"></script>
    <script type="text/javascript" src="__PUBLIC__/vendor/layui/layui.js"></script>
    <link href="__PUBLIC__/css/tablepublic.css" rel="stylesheet">
    <script src="__PUBLIC__/vendor/ie8/respond.min.js"></script>

    <style>
        th{
            text-align: center;
        }
        .form-control{
            display: inline-block;
            width: 250px;
        }
        .wrapper .wrapper-content{
            padding-bottom: 0;
        }
        .control-label{
            font-size: 16px!important;
        }
        .editableform .input-sm{
            width: 120px!important;
            padding-right: 0!important;
             margin-top: 0px;
        }
        table thead{
            background: #4096C7;
            font-size: 16px;
            color: #fff;
        }
        .round{
            width: 65%;
            float: left;
            font-size: 18px;
            font-weight: bold;
            margin-left: 25px;
            margin-bottom:20px;
            color: #084477;
        }
        .tips{
            text-align: left;
            text-indent: 2em;
            font-size: 13px;
            /*font-weight: bold;*/
            margin-left: 2px;
            margin-bottom:15px;
            color: #2f4050;
            margin-top: -12px;
        }
        .tip{
            text-align: left;
            text-indent: 2em;
            font-size: 16px;
            font-weight: bold;
            margin-left: 10px;
            margin-bottom:15px;
            color: #2f4050;
        }
        .btn-hanping{
            background-color: #ea9d49;
			height: 30px;
			line-height: 19px;
			padding: 6px;
			border-color: #cac3bb;
			color: #ffffff;
			font-size: 14px;
			background-color: #5fb878;
        }
		.btn-hanping:hover{
			color: #ffffff;
		}
        .chosen-container-single .chosen-single {
            min-height: inherit;
             height: 37px!important;
            line-height: 32px;
        }
        .active-result,.chosen-single{
            text-align: left;
        }
	.ibox {
    		margin-bottom: 0px;
	}
	.orange>td{
		background-color:#F7C15F!important;
	}
    /*.fixed-table-container thead th .th-inner{
        padding:2px 8px!important;
    }*/
    #sys_wancheng{
         background-color: cornflowerblue;
         border-color: cornflowerblue;
     }
    #sys_refresh{
         background-color: #5ab85a;
         border-color: #5ab85a;
     }
    .btn-green{
         background-color: #5ab85a!important;
         border-color: #5ab85a!important;
     }
    table{
        /*table-layout: auto!important;*/
    }
	.nopadding>.th-inner {
		padding:8px 0px!important;
	}
    </style>
</head>
<body class="gray-bg" style="font-family: 微软雅黑;" >
<div class="" style="overflow: hidden">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <div class="row">
                <div class="col-sm-12">
                    <!--<div>-->
                        <!--<p class="name"  style="text-align: left;font-size:  22px;border-left:5px solid green;padding-left: 10px;font-family: 微软雅黑;margin-bottom: 20px;">项目评审</p>-->
                    <!--</div>-->
                    <div>
                        <div class="_box" style="text-align: right;">
                            <!--<div style="background-color: bisque;padding: 8px 10px 2px 7px;;margin-bottom:5px;width:88.5%;float:left;">-->
                                <!--<p class="tip">评审要点及打分标准：</p>-->
                                <!--{$markRule}-->
                            <!--</div>-->

                            <div style="width: 11.5%;float: left;">
                                <input type="hidden" name="xr_status" id="xr_status" value=""/>
                                <button class="btn btn-success" style="margin-left: 12px;display:block;" type="button" id="sys_refresh"><i class="fa fa-refresh"></i>&nbsp;刷新</button>
                                <!--<button class="btn btn-warning" style="margin-left: 12px;display:block;" type="button" id="sys_wancheng"><i class="fa fa-check"></i>&nbsp;提交</button>-->
                                <!--<button class="btn btn-warning" style="margin-left: 12px;display:block;" type="button" id="sys_saveall"><i class="fa fa-save"></i>&nbsp;全部保存</button>-->
                                <input type="hidden" id="xm_type" name="xm_type" value="{$xmType}"/>
                            </div>
                        </div>
                        <table id="atpbiztable" style="font-size:15px;" data-height=''></table>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<div id="sys_dlg" role="dialog" class="modal fade "></div>
<script type="text/javascript" src="__PUBLIC__/vendor/layui/layui.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/banBackSpace.js"></script>

<script>
    layui.use('layer', function() {
        layer = layui.layer;
    });
	var h = $(window).height()-40;
	$('table').attr('data-height',h);
    $('#atpbiztable').bootstrapTable({
        url: '__CONTROLLER__/getDataVote',
        method: 'post',
        toolbar: '#atpbiztoolbar',
        striped: true,
        cache: false,
        pagination: false,
        iconSize: 'outline',
        sortable: false,
		sortName:"xm_ordernum",
        sortOrder: "asc", 
        queryParams: queryParams,
        sidePagination: "server",
        clickToSelect: true,
        uniqueId: "xr_id",
        detailView: false,
        detailFormatter: "detailFormatter",
        rowStyle:function(row,index){
	        var style = {
                css:{
                    'font-size':'15px'
                }
            };
//	        if(row.notsave == 1){
//		        style = {
//		            css:{
//                    	'font-size':'15px'
//                    },
//		        classes:'orange'
//                }
//            }
            return style;
        },
        columns: tableColumn(),
        onEditableSave:function(field,row,oldValue,$el) {
            var newValue = row[field];
            if(newValue != oldValue){
                var xr_id= row['xr_id'];
//		        $el.parents("tr").addClass("orange");
//		        row.notsave = 1;
                saveVote(xr_id);
            }
//            var totalnum = getTotal(row);
        },
        onPostBody: function (tableValue) {
            var table  = $('#atpbiztable tbody tr');
            var len    = tableValue.length;
            for(var i=0;i<len;i++){
                var ishuibi = tableValue[i].ishuibi;
                var xr_status = tableValue[i].xr_status;
                // 非回避
                if(ishuibi == 1 || xr_status == '完成'){
                    var xr_vote = $(table).eq(i).find('a[data-name="xr_vote"]');
                    $(xr_vote).editable('disable');
                }
            }
        }
    });

    function tableColumn(){
        var column = [
            {field: 'xm_ordernum',title: '答辩<br/>顺序', width: 50,sortable:true},
            {field: 'xm_code', title: '项目编号', sortable: true,width:80},
            {field: 'xm_name', title: '项目名称', sortable: true,width:80,align:'left'},
            {field: 'xm_company', title: '申请单位', sortable: true,width:80,align:'left'},
            {field: 'xm_createuser', title: '申请人', sortable: true,width:50},
            {field: 'xr_vote', title: '投票', sortable: true,width:80,
                formatter:function(value, row, index){
                    var ishuibi = row.ishuibi;
                    var xr_status = row.xr_status;
                    if(ishuibi == '1'){
                        return '回避';
                    }else if(xr_status != '完成'){
                        if(value !== null) {
                            return value;
                        }else if(value == null){
                            return null;
                        }
                    }else if(xr_status == '完成'){
                        if(value == '1') {
                            return '同意立项';
                        }else if(value == '0'){
                            return '暂缓立项';
                        }else{
                            return value;
                        }
                    }
                },
                editable: {
                    type:'select',
                    title:'投票',
                    emptytext:'请投票',
                    showbuttons:false,
                    width:"175px",
                    mode:'inline',
                    onblur:"submit",
                    source:eval('{$voteOption}')
                }
            },
            {field: 'xr_id', title: '操作', sortable: false,width:120,
                formatter: function (value, row, index) {
                    var inp = "'" + value + "'";
                    var a = "";
                    if (row["xr_status"] != "完成") {
                        if(row['ishuibi']!='1') {
                            a += '<a  class="btn btn-danger btn-xs" onclick="huibi(' + inp + ',' + index + ')">回避</a>&nbsp;';
                            a += '<a  class="btn btn-info btn-xs" onclick="XMlook(' + "'" + row.xm_id + "'" + ')">查看材料</a>&nbsp;';
                            a += '<a  class="btn btn-warning btn-xs" onclick="submitInRow(' + inp + ','+index+')">提交</a>';
                        }else{
                            a += '<a  class="btn btn-info btn-green btn-xs" onclick="quxiaohuibi(' + inp + ',' + index + ')">取消回避</a>&nbsp;';
                            a += '<a  class="btn btn-info btn-xs" onclick="XMlook(' + "'" + row.xm_id + "'" + ')">查看材料</a>&nbsp;';
                            a += '<a  class="btn btn-warning btn-xs" onclick="submitInRow(' + inp + ','+index+')">提交</a>';
                        }
                    }else{
                        a += '<a  class="btn btn-info btn-xs" onclick="XMlook(' + "'" + row.xm_id + "'" + ')">查看材料</a>&nbsp;';
                    }
                    return a;
                }
            }
        ];
        return column;
    }
    function queryParams(params) {  //配置参数
        var temp = {   //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
            sort: params.sort,  //排序列名
            sortOrder: params.order,//排位命令（desc，asc）
            xr_status:$("#xr_status").val(),
            xm_type:$("#xm_type").val()
        };
        return temp;
    }
    // 表格内部文字垂直居中
    $('#atpbiztable th').css('vertical-align','middle');
    $('#votetable th').css('vertical-align','middle');
    // 输入字母，文字，‘-’等无法输入
    $('body').on('focus','#atpbiztable .editable-input input',function(){
        var preg = /[^\d]+/g;
        var val  = $(this).val();
        if(val.match(preg) != null){
            $(this).val($(this).val().replace(preg,''));
        }
    });
    $('body').on('keyup','#atpbiztable .editable-input input',function(){
        var preg = /[^\d]+/g;
        var val  = $(this).val();
        if(val.match(preg) != null){
            $(this).val($(this).val().replace(preg,''));
        }
    });
    function submitInRow(id,index)
    {
        var data = $('#atpbiztable').bootstrapTable("getRowByUniqueId",id);
        var xr_vote = data['xr_vote'];
        if(xr_vote === null){
            layer.alert("请先投票！");
            return false;
        }
        layer.confirm("提交后该条数据不可修改，确定提交吗？",{},function(index){
            layer.close(index);
            $.ajax({
                type:'post',
                url:'__CONTROLLER__/submitVote',
                data:{
                    id:id
                },
                success:function(rep){
                    if(rep.code=='0'){
                        data['xr_status'] = '完成';
                        layer.msg(rep.message);
                        $('#atpbiztable').bootstrapTable("updateRow",data);
                    }else{
                        layer.alert(rep.message);
                    }
                },
                dataType:'json'
            });
        });
    }

    function saveVote(id){
        var data = $('#atpbiztable').bootstrapTable("getRowByUniqueId",id);
        if(data != null){
            if(data['xr_vote']=='' || data['xr_vote']==null){
                layer.alert('请先投票');
                return false;
            }

            data['ishuibi'] = 0;
//	        data['notsave'] = null;
            $.ajax({
                type:'post',
                url:'__CONTROLLER__/saveVote',
                data:{
                    data:data,
                    xmType:'{$xmType}'
                },
                success:function(rep){
                    if(rep.code=='0'){
//                        layer.msg(rep.message);
			            $('#atpbiztable').bootstrapTable("updateRow",data);
                    }else{
                        layer.alert(rep.message);
                    }
                },
                dataType:'json'
            });
        }
    }

    function huibi(id,index){
		layer.confirm("确定要回避该项目吗？",{title:'温馨提示'},function(index){	
			var data = $('#atpbiztable').bootstrapTable("getRowByUniqueId",id);
			data['ishuibi'] = 1;
			data['xr_vote'] = -1;
//			data['notsave'] = null;
			$.post('__CONTROLLER__/saveVote',{data:data,xmType:'{$xmType}'},function(rep){
				if(rep.code !='0'){
					layer.alert('保存失败，请重试');
				}else{
					var data = $('#atpbiztable').bootstrapTable("updateRow",{
						index:index,
						row:data
					});
				}
			},'json');
			layer.close(index);
		})
    }

    function quxiaohuibi(id,index){
		layer.confirm("确定要取消回避该项目吗？",{title:'温馨提示'},function(index){
			var data = $('#atpbiztable').bootstrapTable("getRowByUniqueId",id);
			data['xr_vote']=null;
			data['ishuibi'] = 0;
//			data['notsave'] = null;
			$.post('__CONTROLLER__/saveVote',{data:data, xmType:'{$xmType}'},function(rep){
				if(rep.code !='0'){
					layer.alert(rep.message);
				}else{
					var data = $('#atpbiztable').bootstrapTable("updateRow",{
						index:index,
						row:data
					});
				}
			},'json');
			layer.close(index);
		})
    }

    $('#sys_refresh').on('click',function() {
        $('#atpbiztable').bootstrapTable('refresh');
    });

    function detailFormatter(index, row) {
        var html = [];
        html.push("<div class='ibox-content'>");
        html.push("<table class='table'border='1' style='border:1px solid rgb(221, 221, 221) !important;color:white'>");
        html.push("<tbody><tr>");
        html.push("<td style='background-color: #16B5A5;'><b>初审分组</b></td><td style='background-color: #d1ead1;color:#000000;'>" + row['xm_oldfenzu'] + "</td>");//<td><b>推荐方式</b></td><td>"+row['xm_tmfs']+"</td>
        html.push("<td style='background-color: #16B5A5;'><b>初审小组排名</b></td><td style='background-color: #d1ead1;color:#000000;'>" + row['xm_oldrank'] + "</td><td style='background-color: #16B5A5;'><b>初审平均分</b></td><td style='background-color: #d1ead1;color:#000000;'>" + row['xm_oldscore'] + "</td>");
        // html.push("<td><b>资助意见</b></td><td>" + row['xm_oldcommand'] + "</td>");
        html.push("</tr></tbody>");
        html.push("</table>");
        html.push("</div>");
        return html.join('').replace(/null/g, "").replace(/undefined/g, "");
    }

    function getTotal(row){
        var totalnum = 0;
        if('{$markFieldJson}' != '' && '{$markFieldJson}' != null) {
            var markFieldJson = '{$markFieldJson}';
            markFieldJson = eval("{" + markFieldJson + "}");
            for(var i=0;i<markFieldJson.length;i++){
                totalnum += fomatInt(row[markFieldJson[i]]);
            }
        }
        return fomatInt(totalnum);
    }
    /**
     * 格式化为整数
     */
    function fomatInt(number){
        if(isNaN(number) || (number == '') || (number == null)){
            return parseInt(0);
        }
        var f  = parseInt(number);
        return f;
    }
    /**
     * 格式化小数
     */
    function fomatFloat(number){
        if(isNaN(number) || (number == '') || (number == null)){
            return parseInt(0);
        }
        var f  = parseFloat(number);
        return Math.round(f*100)/100;
    }
    function XMlook(id){
        window.open("__MODULE__/ZQXM/listindex?id="+id);
    }
</script>
</body>

</html>




